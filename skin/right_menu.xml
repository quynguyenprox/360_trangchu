<krpano>
    <set var="view_360" val="none" />
    <layer name="skin_scroll_window" keep="true" type="container" align="left" width="100%" height="100%" x="0" y="calc:skin_settings.controlbar_offset + skin_settings.controlbar_height - skin_settings.controlbar_overlap" maskchildren="true" onloaded="skin_calc_opened_closed();" zorder="1" bgroundedge.firefox="1">
        
        <layer name="skin_scroll_layer" type="container" align="bottom" width="40%" height="60%" x="0" y="200" y_offset="get:skin_settings.controlbar_overlap" accuracy="1" bgalpha="get:skin_settings.design_bgalpha" bgcolor="get:skin_settings.design_bgcolor" bgborder="get:skin_settings.design_bgborder" bgroundedge="get:skin_settings.design_bgroundedge" bgshadow="get:skin_settings.design_bgshadow">
            
            <layer name="skin_video_controls" type="container" align="lefttop" edge="leftbottom" width="100%" height="18" visible="false">
                <layer name="skin_video_seekbar_container" type="container" align="lefttop" width="100%" height="100%" bgcapture="true" ondown="skin_video_ondownseeking();" >
                    <layer name="skin_video_seekbar" type="container" bgcolor="0xFFFFFF" bgalpha="0.25" align="center" width="100%" height="2">
                        <layer name="skin_video_loadbar" type="container" bgcolor="0xFFFFFF" bgalpha="0.5" align="left" width="0" height="2" />
                        <layer name="skin_video_seekpos" type="container" bgcolor="0xFFFFFF" bgalpha="1.0" align="left" edge="center" x="0" bgroundedge="8" width="10" height="10" />
                    </layer>
                </layer>
                <layer name="skin_video_time" type="text" align="rightbottom" x="4" enabled="false" bg="false" css="calc:skin_settings.design_text_css + ' text-align:left; font-style:italic; font-size:12px;'" txtshadow="get:skin_settings.design_text_txtshadow" html="0:00 / 0:00" />
            </layer>

            <layer name="skin_scroll_container" type="container" align="lefttop" width="100%" height="100%" x="0" y="0" bgroundedge="get:skin_settings.design_bgroundedge" maskchildren="true">
                <layer name="skin_thumbs_container" type="container" align="lefttop" width="100%" height="100%" visible="false">
                    <layer name="skin_thumbs_scrollleft"  style="skin_base|skin_glow" crop="0|64|64|64"  align="lefttop"  edge="left"  x="5" y="50" scale="0.5" zorder="2" alpha="1.0" ondown="asyncloop(pressed, layer[skin_thumbs].scrollby(+2,0));" visible="false" />
                    <layer name="skin_thumbs_scrollright" style="skin_base|skin_glow" crop="64|64|64|64" align="righttop" edge="right" x="5" y="50" scale="0.5" zorder="2" alpha="1.0" ondown="asyncloop(pressed, layer[skin_thumbs].scrollby(-2,0));" visible="false" />
                    <layer name="skin_thumbs_scrollindicator" type="container" bgcolor="0xFFFFFF" bgalpha="0.25" align="lefttop" width="0" y="100" height="2" visible="false" enabled="false" />
                    <layer name="skin_thumbs" state="closed" type="scrollarea" direction="h" align="top" width="100%" height="100" zorder="1" onloaded="skin_updatethumbsview(false);" onscroll="skin_updatethumbscroll();" />
                </layer>
            </layer>

        </layer>        
    </layer>

    <layer name="skin_control_bar" type="container" align="bottomright" width="44" height="400" x="5" y="5" keep="true" zorder="100" bgcolor="0x00ff00" bgalpha="1">
            <!-- ===== TOGGLE BUTTON ===== -->
        <layer name="btn_hide_container" type="container" align="bottom" width="44" height="44" y="0" zorder="101" bgcolor="0xff0000" bgalpha="1">
            <layer name="bg_hide" type="container" align="bottomright" width="40" height="40" bgcolor="0x44B5E8" bgalpha="0.45" bgroundedge="20" bgcapture="true" handcursor="true" onclick="toggle_control_buttons();" onhover="skin_showtooltip_menu('Ẩn/Hiện Menu');" onout="skin_hidetooltips();">
                <layer name="icon_hide" url="/skin/icons/hide.png" align="center" width="45" height="45" scale="0.5" rotate="90" capture="false" />
            </layer>
        </layer>
            <!-- ===== BUTTONS GROUP ===== -->
        <layer name="buttons_group" type="container" align="bottom" y="44" width="44" height="350" visible="false" alpha="1.0" zorder="100" bgcolor="0x0000ff" bgalpha="1">  
            
            <layer name="btn_full_screen" type="container" align="bottomright" width="40" height="40" y="0" bgcolor="0xFF5733" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="toggle_fullscreen();" onhover="skin_showtooltip_menu('Bật/Tắt toàn màn hình');" onout="skin_hidetooltips();">
                <layer name="icon_full_screen" url="/skin/icons/fullscreen.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_auto" type="container" align="bottomright" width="40" height="40" y="44" bgcolor="0xC70039" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="toggle_autorotate();" onhover="skin_showtooltip_menu('Bật/Tắt tự xoay');" onout="skin_hidetooltips();">
                <layer name="icon_auto" url="/skin/icons/auto.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_camera" type="container" align="bottomright" width="40" height="40" y="88" bgcolor="0x900C3F" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="trace('Đã bấm nút 3')" onhover="skin_showtooltip_menu('Chụp hình');" onout="skin_hidetooltips();">
                <layer name="icon_camera" url="/skin/icons/camera.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_vr" type="container" align="bottomright" width="40" height="40" y="132" bgcolor="0x581845" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="webvr.enterVR();" onhover="skin_showtooltip_menu('Thực tế ảo');" onout="skin_hidetooltips();">
                <layer name="icon_vr" url="/skin/icons/vr.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_360" type="container" align="bottomright" width="40" height="40" y="176" bgcolor="0x28B463" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="view_360_action();" onhover="skin_showtooltip_menu('Toàn cảnh');" onout="skin_hidetooltips();">
                <layer name="icon_360" url="/skin/icons/360.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_menu" type="container" align="bottomright" width="40" height="40" y="220" bgcolor="0xD4AC0D" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="skin_showthumbs();" onhover="skin_showtooltip_menu('Album ảnh');" onout="skin_hidetooltips();">
                <layer name="icon_menu" url="/skin/icons/menu.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_view" type="container" align="bottomright" width="40" height="40" y="264" bgcolor="0x2E86C1" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="start_vr();" onhover="skin_showtooltip_menu('Tổng quan địa điểm');" onout="skin_hidetooltips();">
                <layer name="icon_view" url="/skin/icons/view.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer>

            <layer name="btn_prev" type="container" align="bottomright" width="40" height="40" y="308" bgcolor="0x884EA0" bgalpha="1" bgroundedge="20" bgcapture="true" handcursor="true" onclick="trace('Đã bấm nút 8')" onhover="skin_showtooltip_menu('Trở lại ảnh trước');" onout="skin_hidetooltips();">
                <layer name="icon_prev" url="/skin/icons/prev.png" align="center" width="45" height="45" scale="0.5" capture="false" />
            </layer> 
        </layer> <!-- END buttons_group -->
    </layer>     <!-- END skin_control_bar -->

    <!--Tắt mở menu phải-->
    <action name="toggle_control_buttons">
        if(layer[buttons_group].visible == true,
            
            tween(layer[buttons_group].alpha, 0.0, 0.25, default, set(layer[buttons_group].visible, false));
            
            tween(layer[icon_hide].rotate, 90, 0.25);

        ,
            set(layer[buttons_group].visible, true);
            
            tween(layer[buttons_group].alpha, 1.0, 0.25);
            
            tween(layer[icon_hide].rotate, 0, 0.25);
        );
    </action>

    <!--Full màn hình-->
    <!--Full màn hình-->
    <action name="toggle_fullscreen">
        trace('TOGGLE FULLSCREEN CLICKED');
        if(fullscreen,
            set(fullscreen,false);
        ,
            set(fullscreen,true);
        );
        update_fullscreen_icon();
    </action>
    <!--Full màn hình-->
    <action name="update_fullscreen_icon">
        if(fullscreen,
            set(layer[icon_full_screen].url, /skin/icons/fullscreen.png);
        ,
            set(layer[icon_full_screen].url, /skin/icons/exit.png);
        );
    </action>

    <!--Xoay xoay-->
    <!--Xoay xoay-->
    <action name="toggle_autorotate">
        if(autorotate.enabled,
            set(autorotate.enabled,false);
            skin_showtooltip_menu('Dừng tự xoay');
        ,
            set(autorotate.enabled,true);
            skin_showtooltip_menu('Tự xoay');
        );
        update_auto_icon();
    </action>
    <!--Xoay xoay-->
    <action name="update_auto_icon">
        if(autorotate.enabled,
            set(layer[icon_auto].url,/skin/icons/auto.png);
        ,
            set(layer[icon_auto].url,/skin/icons/on.png);
        );
    </action>

    <!--Xem 360-->
	<action name="view_360_action" scope="local">
		if(view_360 == 'none',
		set(view_360, 'sky');
		cm_littleplanet_view(0, 60);
		,
			if(view_360 == 'sky',
				set(view_360, 'land');
				cm_littleplanet_view(0, -60);
			,
				set(view_360, 'none');
				cm_littleplanet_view(0, 0);
			);
		);
	</action>

    <!--Xem 360-->
	<action name="cm_littleplanet_view">
		set(view.fovtype, "MFOV");

		if(view_360 != 'none',
			set(view.stereographic, true);
			tween(view.fisheye, 1.0, 1.5, easeOutExpo);
			set(view.fov, 240);
		,
			set(view.stereographic, false);
			tween(view.fisheye, 0, 0, easeOutExpo);
			set(view.fov, 120);
		);

		lookto(%1, %2, get(view.fov), 120, 100, easeOutExpo);
	</action>

    <!--Xem tổng quan-->
	<action name="start_vr">
		if(hotspot[thumb_wall].visible,
			hide_all_thumbs();
			tween(hotspot[thumb_wall].alpha, 0, 0.5, easeOutExpo);,
			show_all_thumbs();
			tween(hotspot[thumb_wall].alpha, 1.0, 0.5, easeOutExpo);
		);
	</action>
    <!--Xem tổng quan-->
	<action name="skin_showthumbs" scope="local" args="show">
		if(show == null, if(layer[skin_thumbs].state == 'closed', set(show,true), set(show,false)); );
		if(show,
			set(layer[skin_thumbs].state, 'opened');
			tween(layer[skin_thumbs].alpha, 1.0, 0.25);
			tween(layer[skin_scroll_layer].y, calc(- area.pixelheight / 2 + layer[skin_thumbs].height + 65), 0.5, easeOutQuint);
			set(layer[skin_thumbs_container].visible, true);
			tween(layer[skin_thumbs_container].alpha, 1.0, 0.25);
			tween(layer[skin_map].alpha, 0.0, 0.25, default, set(layer[skin_map].visible,false));
		  ,
			set(layer[skin_thumbs].state, 'closed');
			tween(layer[skin_thumbs].alpha, 0.0, 0.25, easeOutQuint);
			tween(layer[skin_scroll_layer].y, calc(- area.pixelheight / 2), 0.5, easeOutQuint, set(layer[skin_thumbs_container].visible, false););
		);
	</action>
    <!--Xem tổng quan, Action xử lý kích thước & hiển thị Thumbnails-->
	<action name="skin_updatethumbsview" scope="local" args="scroll">
		if(layer[skin_thumbs].loaded,
			set(cursceneindex, 0);
			if(xml.scene, copy(cursceneindex, scene[get(xml.scene)].index));
			if(scroll == false,
				layer[skin_thumbs].setcenter(get(scene[get(cursceneindex)].thumbx), get(scene[get(cursceneindex)].thumby));
			  ,
				layer[skin_thumbs].scrolltocenter(get(scene[get(cursceneindex)].thumbx), get(scene[get(cursceneindex)].thumby));
			);
		);
	</action>
    <!--Xem tổng quan, Action xử lý nút mũi tên trái/phải-->
	<action name="skin_updatethumbscroll" scope="local">
		copy(padding,skin_settings.thumbs_padding);

		if(skin_settings.thumbs_scrollbuttons,
			if(caller.loverflow GT 0, set(layer[skin_thumbs_scrollleft].visible,true),  set(layer[skin_thumbs_scrollleft].visible,false) );
			if(caller.roverflow GT 0, set(layer[skin_thumbs_scrollright].visible,true), set(layer[skin_thumbs_scrollright].visible,false) );
		);

		if(skin_settings.thumbs_scrollindicator,
			if(caller.woverflow GT 0,
				set(layer[skin_thumbs_scrollindicator].visible, true);
				sub(iw,caller.pixelwidth,caller.woverflow);
				div(pw,iw,caller.pixelwidth);
				div(px,caller.loverflow,caller.woverflow);
				mul(pw,iw);
				copy(layer[skin_thumbs_scrollindicator].width, pw);
				sub(iw,pw);
				sub(iw,padding);
				sub(iw,padding);
				mul(px,iw);
				add(px,padding);
				copy(layer[skin_thumbs_scrollindicator].x, px);
			  ,
				set(layer[skin_thumbs_scrollindicator].visible, false);
			);
		);
	</action>
    <!--Xem tổng quan, Action xử lý tua Video-->
	<action name="skin_video_ondownseeking" scope="local">
		asyncloop(caller.pressed,
			screentolayer(skin_video_seekbar, mouse.stagex,mouse.stagey, lx,ly);
			calc(seekpos, lx / layer[skin_video_seekbar].pixelwidth);
			clamp(seekpos, 0.0, 1.0);
			skin_video_updatetime(get(seekpos));
		  ,
			plugin[video].seek(calc((seekpos * 100) + '%'));
		);
	</action>
    <!--Xem tổng quan-->
    <!-- a background grid -->
	<preview type="grid" />
    <style name="hittesttextfield"
        type="text" textalign="center"
        bgcolor="0x7777DD" bgalpha="0.8" bgborder="1 0x000000 1.0" oversampling="1"
        zorder="1" depthbuffer="true"
        />
    <hotspot name="thumb_wall"
            style="hittesttextfield"
            ath="0"
            atv="0"
            width="800"
            height="500"
            visible="true"
            zorder="10"
            distorted="true"
            depth="1000"
            keep="true"
            background="true"
            bgcolor="0xFFFFFF"
            bgalpha="0.3" />

    <hotspot name="close_button_wall"
            type="image"
            url="icons/close.png"
            ath="0"
            atv="0"
            ox="380"
            oy="-230"
            scale="1"
            width="32"
            height="32"
            distorted="true"
            handcursor="true"
            zorder="11"
            depth="1001"
            keep="true"
            onclick="hide_all_thumbs();" />
    <!--Xem tổng quan-->
    <action name="hide_all_thumbs" scope="local">
        set(i, 0);
        for(set(i, 0), i LT global.thumbs.length, inc(i),
            copy(hsname, global.thumbs[get(i)]);

            set(hotspot[get(hsname)].visible, false);
            set(hotspot[calc(get(hsname) + '_text')].visible, false);
            set(hotspot[calc(get(hsname) + 'bg')].visible, false);
        );
        set(hotspot[thumb_wall].visible, false);
        set(hotspot[close_button_wall].visible, false);
    </action>
    <!--Xem tổng quan-->
    <action name="generate_scene_thumbs" scope="local" autorun="onstart">
        set(i, 0);
        set(columns, 3);                  <!-- số cột của lưới thumbnails -->
        def(global.thumbs, array);
        def(global.scence_array, array);
        set(global.scence_array.count, 0);

        for(set(sceneindex, 0), sceneindex LT scene.count, inc(sceneindex),

            copy(scname, scene[get(sceneindex)].name);
            copy(title, scene[get(scname)].title);
            copy(thumburl, scene[get(scname)].thumburl);

            <!-- Tính vị trí grid -->
            mod(x, get(i), get(columns));
            div(y, get(i), get(columns));
            Math.floor(y);
            <!-- Tính offset (tọa độ) -->
            set(ox, calc(get(x) * 250 - 240));   <!-- khoảng cách ngang, canh giữa -->
            set(oy, calc(get(y) * 160 - 150));   <!-- khoảng cách dọc -->

                    <!-- Tạo thumbnail -->
            addhotspot(get(scname));
            <!-- set(hotspot[get(scname)].parent, thumb_wall); -->
            set(hotspot[get(scname)].url, get(thumburl));
            set(hotspot[get(scname)].type, 'image');
            set(hotspot[get(scname)].ox, get(ox));
            set(hotspot[get(scname)].oy, calc(get(oy) - 10));
            set(hotspot[get(scname)].width, 180);
            set(hotspot[get(scname)].height, 80);
            set(hotspot[get(scname)].scale, 1.0);
            set(hotspot[get(scname)].distorted, true);
            set(hotspot[get(scname)].zorder, 14);
            set(hotspot[get(scname)].keep, true);
            set(temp, calc('skin_loadscene(' + get(scname) + ',' + get(skin_settings.loadscene_blend) + ');' + 'hide_all_thumbs();'));
            set(hotspot[get(scname)].onclick, get(temp));
            <!-- Tạo thumbnail -->
            addhotspot(calc(get(scname) + 'bg'));
            <!-- set(hotspot[get(scname)].parent, thumb_wall); -->
            set(hotspot[calc(get(scname) + 'bg')].url, skin/icons/bg_image.png);
            set(hotspot[calc(get(scname) + 'bg')].type, 'image');
            set(hotspot[calc(get(scname) + 'bg')].ox, get(ox));
            set(hotspot[calc(get(scname) + 'bg')].oy, get(oy));
            set(hotspot[calc(get(scname) + 'bg')].width, 200);
            set(hotspot[calc(get(scname) + 'bg')].height, 130);
            set(hotspot[calc(get(scname) + 'bg')].distorted, true);
            set(hotspot[calc(get(scname) + 'bg')].zorder, 13);
            set(hotspot[calc(get(scname) + 'bg')].keep, true);
            set(hotspot[calc(get(scname) + 'bg')].background, true);
            set(hotspot[calc(get(scname) + 'bg')].bgroundedge, 7);

            <!-- Thêm text title -->
            addhotspot(calc(get(scname) + '_text'));
            <!-- set(hotspot[get(scname) + '_text'].parent, thumb_wall); -->
            set(hotspot[calc(get(scname) + '_text')].type, text);
            set(hotspot[calc(get(scname) + '_text')].html, get(title));
            set(hotspot[calc(get(scname) + '_text')].css, 'text-align:center;color:#fff;font-size:12px;background:none;background-color:none;');
            set(hotspot[calc(get(scname) + '_text')].width, 200);
            set(hotspot[calc(get(scname) + '_text')].height, 20);
            set(hotspot[calc(get(scname) + '_text')].ox, get(ox));
            set(hotspot[calc(get(scname) + '_text')].distorted, true);
            set(hotspot[calc(get(scname) + '_text')].oy, calc(get(oy) + 40));
            set(hotspot[calc(get(scname) + '_text')].keep, true);
            set(hotspot[calc(get(scname) + '_text')].zorder, 14);
            set(hotspot[calc(get(scname) + '_text')].background, false);

            <!-- Lưu vào mảng -->
            set(global.thumbs[get(global.thumbs.length)], get(scname));

            inc(i);
        );
        hide_all_thumbs();
    </action>
    <!--Xem tổng quan-->
    <action name="get_next_scene" scope="local">
        set(nextscenename, "");
        if(isset(scene[get(xml.scene)].thumbindex),
            sub(lastsceneindex, thumbarray.length, 1);
            add(nextscenename, scene[get(xml.scene)].thumbindex, +1);
            if(nextscenename LT 0, copy(nextscenename,lastsceneindex));
            if(nextscenename GT lastsceneindex, set(nextscenename,0));
            set(nextscenename, get(thumbarray[get(nextscenename)].title));
            ,
            add(nextscenename, scene[get(xml.scene)].index, +1);
            sub(lastsceneindex, scene.count, 1);
            if(nextscenename LT 0, copy(nextscenename,lastsceneindex));
            if(nextscenename GT lastsceneindex, set(nextscenename,0));
            set(nextscenename, get(scene[get(nextscenename)].title));
        );
        if(nextscenename != null,
            set(layer[text_next_scene].html, get(nextscenename));
        );
    </action>
    <!--Xem tổng quan-->
    <action name="show_all_thumbs" scope="local">
        set(i, 0);
        for(set(i, 0), i LT global.thumbs.length, inc(i),
            copy(hsname, global.thumbs[get(i)]);

            set(hotspot[get(hsname)].visible, true);
            set(hotspot[calc(get(hsname) + '_text')].visible, true);
            set(hotspot[calc(get(hsname) + 'bg')].visible, true);

            set(hotspot[get(hsname)].atv, get(view.vlookat));
            set(hotspot[calc(get(hsname) + '_text')].atv, get(view.vlookat));
            set(hotspot[calc(get(hsname) + 'bg')].atv, get(view.vlookat));
            set(hotspot[get(hsname)].ath, get(view.hlookat));
            set(hotspot[calc(get(hsname) + '_text')].ath, get(view.hlookat));
            set(hotspot[calc(get(hsname) + 'bg')].ath, get(view.hlookat));
        );
        set(hotspot[thumb_wall].visible, true);
        set(hotspot[close_button_wall].visible, true);
        set(hotspot[thumb_wall].atv, get(view.vlookat));
        set(hotspot[close_button_wall].atv, get(view.vlookat));
        set(hotspot[thumb_wall].ath, get(view.hlookat));
        set(hotspot[close_button_wall].ath, get(view.hlookat));
    </action>
    <!--Xem tổng quan-->
	<action name="skin_addcustommapspots">
		if(device.mobile OR device.tablet,
			calc(spotname, 'spothere');
			addlayer(get(spotname));
			set(layer[get(spotname)].url, skin/icons/here.png);
			set(layer[calc(get(spotname))].visible, true);
			set(layer[calc(get(spotname))].parent, "skin_map");
			set(layer[calc(get(spotname))].width, 30);
			set(layer[calc(get(spotname))].x, calc(stagewidth * get(scene[get(xml.scene)].mapx)- 5));
			set(layer[calc(get(spotname))].y, calc(stageheight / 2 * get(scene[get(xml.scene)].mapy)- 15));
			set(layer[calc(get(spotname))].height, 30);
			set(layer[calc(get(spotname))].zorder, 3);
			set(layer[calc(get(spotname))].onloaded, do_animation(120,120,10));
		,
			calc(spotname, 'spothere');
			addlayer(get(spotname));
			set(layer[get(spotname)].url, skin/icons/here.png);
			set(layer[calc(get(spotname))].visible, true);
			set(layer[calc(get(spotname))].parent, "skin_map");
			set(layer[calc(get(spotname))].width, 30);
			set(layer[calc(get(spotname))].x, calc(layer[skin_map_layer].pixelwidth * get(scene[get(xml.scene)].mapx)- 5));
			set(layer[calc(get(spotname))].y, calc(layer[skin_map_layer].pixelheight * get(scene[get(xml.scene)].mapy)- 15));
			set(layer[calc(get(spotname))].height, 30);
			set(layer[calc(get(spotname))].zorder, 3);
			set(layer[calc(get(spotname))].onloaded, do_animation(120,120,10));
		)
			
	</action>
    <!--Xem tổng quan-->
	<action name="locate_map_hover" scope="local" args="layertoglow, layertext, istrue">
		if(layertoglow != null,
			if(istrue,
				set(layer[get(layertoglow)].visible, true);
				set(layer[get(layertext)].visible, true);
				,
				set(layer[get(layertoglow)].visible, false);
				set(layer[get(layertext)].visible, false);
			);
		);
	</action>
    <!--Xem tổng quan-->
	<action name="skin_addcustommapspots_around">
		copy(curx, scene[get(xml.scene)].mapx);
		copy(cury, scene[get(xml.scene)].mapy);
		if(device.mobile OR device.tablet,
			for(set(i,0), i LT scene.count, inc(i),
				if(scene[get(i)].mapx AND scene[get(i)].mapy,
					if( !(scene[get(i)].mapx == get(curx) AND scene[get(i)].mapy == get(cury)),
						copy(spotaroundscname, scene[get(i)].name);
						copy(spotaround, scene[get(i)].name );
						addlayer(calc(get(spotaround)+'map'));
						set(layer[calc(get(spotaround)+ 'map')].url, skin/icons/here1.png);
						set(layer[calc(get(spotaround)+ 'map')].type, 'image');
						set(layer[calc(get(spotaround)+ 'map')].visible, true);
						set(layer[calc(get(spotaround)+ 'map')].parent, "skin_map");

						set(layer[calc(get(spotaround)+ 'map')].ox, calc(calc(stagewidth) * get(scene[get(i)].mapx)));
						set(layer[calc(get(spotaround)+ 'map')].oy, calc(calc(stageheight/2)* get(scene[get(i)].mapy)));
						set(layer[calc(get(spotaround)+ 'map')].width, 20);
						set(layer[calc(get(spotaround)+ 'map')].height, 20);
						set(layer[calc(get(spotaround)+ 'map')].zorder, 3);
						set(temp, calc('skin_loadscene(' + get(spotaroundscname) + ', ' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+ 'map')].onclick, get(temp));

						set(layer[calc(get(spotaround)+ 'map')].onloaded, do_animation(120,120,10));

						copy(thumburl, scene[get(i)].thumburl);
						
								<!-- Tạo thumbnail -->
						addlayer(calc(get(spotaround)+'thumbmap'));
						set(layer[calc(get(spotaround)+'thumbmap')].url, get(thumburl));
						
						set(layer[calc(get(spotaround)+'thumbmap')].type, 'image');
						set(layer[calc(get(spotaround)+'thumbmap')].ox, calc(calc(stagewidth)*calc(get(scene[get(i)].mapx))-20));
						set(layer[calc(get(spotaround)+'thumbmap')].oy, calc(calc(stageheight/2)*calc(get(scene[get(i)].mapy))-35));
						set(layer[calc(get(spotaround)+'thumbmap')].width, 60);
						set(layer[calc(get(spotaround)+'thumbmap')].height, 40);
						set(layer[calc(get(spotaround)+'thumbmap')].visible, false);
						set(layer[calc(get(spotaround)+'thumbmap')].parent, "skin_map");
						set(layer[calc(get(spotaround)+'thumbmap')].scale, 1.0);
						set(layer[calc(get(spotaround)+'thumbmap')].distorted, true);
						set(layer[calc(get(spotaround)+'thumbmap')].zorder, 4);
						set(layer[calc(get(spotaround)+'thumbmap')].keep, true);
						
						set(temp, calc('skin_loadscene(' + get(spotaround) + ',' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+'thumbmap')].onclick, get(temp));
						<!-- Thêm text title -->
						addlayer(calc(get(spotaround) + '_text'));
						set(layer[calc(get(spotaround) + '_text')].type, text);
						set(layer[calc(get(spotaround) + '_text')].html, get(scene[get(i)].title));
						set(layer[calc(get(spotaround) + '_text')].css, 'text-align:center;color:#fff;font-size:10px;background:none;background-color:0x7777DD;');
						set(layer[calc(get(spotaround) + '_text')].width, 100);
						set(layer[calc(get(spotaround)+'_text')].visible, false);
						set(layer[calc(get(spotaround) + '_text')].parent, "skin_map");
						set(layer[calc(get(spotaround) + '_text')].height, 20);
						set(layer[calc(get(spotaround) + '_text')].distorted, true);
						set(layer[calc(get(spotaround)+'_text')].ox, calc(calc(stagewidth)*calc(get(scene[get(i)].mapx))-40));
						set(layer[calc(get(spotaround)+'_text')].oy, calc(calc(stageheight/2)*calc(get(scene[get(i)].mapy))));
						set(layer[calc(get(spotaround) + '_text')].keep, true);
						set(layer[calc(get(spotaround) + '_text')].zorder, 4);
						set(layer[calc(get(spotaround) + '_text')].background, false);
						set(temp, calc('skin_loadscene(' + get(spotaround) + ',' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+'_text')].onclick, get(temp));
						set(temptrue, calc('locate_map_hover("' + spotaround + 'thumbmap","' + spotaround + '_text", true);'));
						set(tempfalse, calc('locate_map_hover("' + spotaround + 'thumbmap","' + spotaround + '_text", false);'));
						set(layer[calc(get(spotaround)+ 'thumbmap')].onout, get(tempfalse));
						set(layer[calc(get(spotaround)+ 'map')].onover, get(temptrue));
						set(layer[calc(get(spotaround)+ '_text')].onout, get(tempfalse));
					);
				);
			);
			,
			for(set(i,0), i LT scene.count, inc(i),
				if(scene[get(i)].mapx AND scene[get(i)].mapy,
					if( !(scene[get(i)].mapx == get(curx) AND scene[get(i)].mapy == get(cury)),
						copy(spotaroundscname, scene[get(i)].name);
						copy(spotaround, scene[get(i)].name );
						addlayer(calc(get(spotaround)+'map'));
						set(layer[calc(get(spotaround)+ 'map')].url, skin/icons/here1.png);
						set(layer[calc(get(spotaround)+ 'map')].type, 'image');
						set(layer[calc(get(spotaround)+ 'map')].visible, true);
						set(layer[calc(get(spotaround)+ 'map')].parent, "skin_map");
						set(layer[calc(get(spotaround)+ 'map')].ox, calc(calc(layer[skin_map_layer].pixelwidth -0) * get(scene[get(i)].mapx)));
						set(layer[calc(get(spotaround)+ 'map')].oy, calc(calc(layer[skin_map_layer].pixelheight -0)* get(scene[get(i)].mapy)));
						set(layer[calc(get(spotaround)+ 'map')].width, 20);
						set(layer[calc(get(spotaround)+ 'map')].height, 20);
						set(layer[calc(get(spotaround)+ 'map')].zorder, 3);
						set(temp, calc('skin_loadscene(' + get(spotaroundscname) + ', ' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+ 'map')].onclick, get(temp));

						set(layer[calc(get(spotaround)+ 'map')].onloaded, do_animation(120,120,10));

						copy(thumburl, scene[get(i)].thumburl);
						
								<!-- Tạo thumbnail -->
						addlayer(calc(get(spotaround)+'thumbmap'));
						set(layer[calc(get(spotaround)+'thumbmap')].url, get(thumburl));
						
						set(layer[calc(get(spotaround)+'thumbmap')].type, 'image');
						set(layer[calc(get(spotaround)+'thumbmap')].ox, -20);
						set(layer[calc(get(spotaround)+'thumbmap')].oy, -10);
						set(layer[calc(get(spotaround)+'thumbmap')].width, 60);
						set(layer[calc(get(spotaround)+'thumbmap')].height, 40);
						set(layer[calc(get(spotaround)+'thumbmap')].visible, false);
						set(layer[calc(get(spotaround)+'thumbmap')].parent, calc(get(spotaround)+ 'map'));
						set(layer[calc(get(spotaround)+'thumbmap')].scale, 1.0);
						set(layer[calc(get(spotaround)+'thumbmap')].distorted, true);
						set(layer[calc(get(spotaround)+'thumbmap')].zorder, 4);
						set(layer[calc(get(spotaround)+'thumbmap')].keep, true);
						
						set(temp, calc('skin_loadscene(' + get(spotaround) + ',' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+'thumbmap')].onclick, get(temp));
						<!-- Thêm text title -->
						addlayer(calc(get(spotaround) + '_text'));
						set(layer[calc(get(spotaround) + '_text')].type, text);
						set(layer[calc(get(spotaround) + '_text')].html, get(scene[get(i)].title));
						set(layer[calc(get(spotaround) + '_text')].css, 'text-align:center;color:#fff;font-size:10px;background:none;background-color:0x7777DD;');
						set(layer[calc(get(spotaround) + '_text')].width, 100);
						set(layer[calc(get(spotaround)+'_text')].visible, false);
						set(layer[calc(get(spotaround) + '_text')].parent, calc(get(spotaround)+ 'map'));
						set(layer[calc(get(spotaround) + '_text')].height, 20);
						set(layer[calc(get(spotaround) + '_text')].distorted, true);
						set(layer[calc(get(spotaround)+'_text')].ox, -40);
						set(layer[calc(get(spotaround)+'_text')].oy, 30);
						set(layer[calc(get(spotaround) + '_text')].keep, true);
						set(layer[calc(get(spotaround) + '_text')].zorder, 4);
						set(layer[calc(get(spotaround) + '_text')].background, false);
						set(temp, calc('skin_loadscene(' + get(spotaround) + ',' + get(skin_settings.loadscene_blend) + ');'));
						set(layer[calc(get(spotaround)+'_text')].onclick, get(temp));
						set(temptrue, calc('locate_map_hover("' + spotaround + 'thumbmap","' + spotaround + '_text", true);'));
						set(tempfalse, calc('locate_map_hover("' + spotaround + 'thumbmap","' + spotaround + '_text", false);'));
						set(layer[calc(get(spotaround)+ 'thumbmap')].onout, get(tempfalse));
						set(layer[calc(get(spotaround)+ 'map')].onover, get(temptrue));
						set(layer[calc(get(spotaround)+ '_text')].onout, get(tempfalse));
					);
				);
			);
		)
	</action>
    <!--Xem tổng quan-->
	<action name="remove_thumb_map" scope="local">
		set(i, 0);
		for(set(i, 0), i LT scene.count, inc(i),
			copy(spotaround, scene[get(i)].name );
			removelayer(calc(get(spotaround) + 'thumbmap'));
			removelayer(calc(get(spotaround) + '_text'));
		);
	</action>
    <!--Xem tổng quan-->
	<action name="do_animation" scope="local" args="framewidth, frameheight, framerate">
		<!-- define local variables -->
		calc(local.xframes, (caller.imagewidth /framewidth) BOR 0);
		calc(local.frames, xframes * ((caller.imageheight / frameheight) BOR 0));
		def(local.frame, integer, 0);
		
		<!-- set the first frame -->
		calc(caller.crop, '0|0|' + framewidth + '|' + frameheight);
		
		<!-- do the animation -->
		setinterval(calc('crop_anim_' + caller.name), calc(1.0 / framerate),
			if(caller.loaded,
				inc(frame);
				if(frame GE frames, if(caller.onlastframe !== null, callwith(caller, onlastframe() ) ); set(frame,0); );
				mod(xpos, frame, xframes);
				div(ypos, frame, xframes);
				Math.floor(ypos);
				mul(xpos, framewidth);
				mul(ypos, frameheight);
				calc(caller.crop, xpos + '|' + ypos + '|' + framewidth + '|' + frameheight);
			  ,
				<!-- stop the interval when the hotspot gets removed -->
				clearinterval(calc('crop_anim_' + caller.name));
			);
		);
	</action>

</krpano>